<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, viewport-fit=cover"
  />
  <title>Luminous Bulb â€” Elegant Toggle</title>
  <meta name="description" content="A beautiful single-page bulb toggle with smooth animations and delightful design." />
  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet" />
  <style>
    :root{
      --bg-1: 255, 180, 162;
      --bg-2: 197, 222, 234;
      --bg-3: 255, 236, 210;
      --bg-4: 231, 214, 255;

      --surface: rgba(255,255,255,0.12);
      --border: rgba(255,255,255,0.22);

      --text: rgba(255,255,255,0.92);
      --text-dim: rgba(255,255,255,0.72);
      --shadow: 0 10px 40px rgba(0,0,0,0.25), 0 20px 80px rgba(0,0,0,0.18);

      --glow-strong: 255, 224, 130; /* warm glow */
      --glow-soft: 255, 248, 200;

      --bulb-glass-off: 210, 220, 235;
      --bulb-glass-on: 255, 244, 175;
      --bulb-reflection: 255, 255, 255;

      --bulb-base: 54, 63, 77;
      --bulb-screw: 92, 105, 124;

      --speed: 360ms;
      --easing: cubic-bezier(.2,.8,.2,1);
      --brightness: 1; /* 0..1 bulb intensity */
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --surface: rgba(255,255,255,0.10);
        --border: rgba(255,255,255,0.16);
        --text: rgba(255,255,255,0.96);
        --text-dim: rgba(255,255,255,0.70);
      }
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: "Inter", system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
      color: var(--text);
      background: radial-gradient(1200px 800px at 20% 10%, rgba(var(--bg-1), .45), transparent 60%),
                  radial-gradient(900px 700px at 80% 20%, rgba(var(--bg-2), .45), transparent 60%),
                  radial-gradient(1000px 900px at 40% 90%, rgba(var(--bg-4), .35), transparent 60%),
                  radial-gradient(900px 800px at 85% 80%, rgba(var(--bg-3), .35), transparent 60%),
                  linear-gradient(135deg, #0a0c10, #0d1117 50%, #121826);
      background-attachment: fixed;
      overflow-x: hidden;
    }

    .grid {
      min-height: 100%;
      display: grid;
      place-items: center;
      padding: 6vmin 3vmin;
    }

    .card {
      width: min(1100px, 95vw);
      border-radius: 28px;
      backdrop-filter: blur(18px) saturate(120%);
      -webkit-backdrop-filter: blur(18px) saturate(120%);
      background: linear-gradient(180deg, rgba(255,255,255,0.14), rgba(255,255,255,0.06));
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      padding: clamp(18px, 3vmin, 32px);
      position: relative;
      overflow: hidden;
      isolation: isolate;
    }

    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      margin-bottom: 24px;
      padding: 0 6px;
    }

    .title {
      font-weight: 800;
      letter-spacing: 0.3px;
      line-height: 1.15;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 14px;
      font-size: clamp(18px, 3.2vmin, 24px);
    }
    .title .dot {
      width: 12px; height: 12px; border-radius: 999px;
      background: radial-gradient(circle at 30% 30%, #fff, rgba(var(--glow-strong), 0.9));
      box-shadow: 0 0 0 3px rgba(255,255,255,0.12), 0 0 12px rgba(var(--glow-strong), 0.75);
      transform: translateY(1px);
    }
    .subtitle {
      margin: 0;
      opacity: 0.8;
      font-weight: 400;
      color: var(--text-dim);
      font-size: clamp(12px, 2.2vmin, 14px);
    }

    .scene {
      display: grid;
      grid-template-columns: 1fr min(36vmin, 420px);
      grid-template-rows: auto;
      align-items: center;
      justify-items: start;
      align-content: start;
      gap: clamp(8px, 1.2vmin, 14px);
      padding: clamp(8px, 1.5vmin, 16px);
    }

    /* Bulb stage */
    .stage {
      width: min(70vh, 58vmin, 640px, 90vw);
      aspect-ratio: 4 / 3; /* further reduced to minimize bottom space */
      display: grid;
      place-items: center;
      position: relative;
    }
    /* Aura halo */
    .halo {
      position: absolute;
      inset: 0;
      margin: auto;
      width: 78%;
      height: 78%;
      border-radius: 50%;
      background: radial-gradient(closest-side, rgba(var(--glow-soft), 0.0), transparent 60%);
      filter: blur(10px);
      opacity: 0;
      transition: opacity var(--speed) var(--easing), transform var(--speed) var(--easing);
      transform: scale(0.98);
      z-index: 0;
    }
    .is-on .halo {
      opacity: var(--brightness);
      background: radial-gradient(closest-side, rgba(var(--glow-soft), 0.28), rgba(var(--glow-strong), 0.06) 55%, transparent 70%);
      transform: scale(1);
      animation: haloPulse 3.5s ease-in-out infinite;
    }
    @keyframes haloPulse {
      0%, 100% { transform: scale(1); filter: blur(10px); }
      50%      { transform: scale(1.03); filter: blur(14px); }
    }

    /* Floating animation for the bulb */
    .float {
      animation: float 6s ease-in-out infinite;
      will-change: transform;
    }
    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50%      { transform: translateY(-2px); }
    }

    /* Controls */
    .controls {
      display: flex;
      flex-direction: column;
      align-items: stretch;
      justify-content: flex-start;
      align-self: start;
      gap: 12px;
      width: 100%;
    }
    .controls .btn,
    .controls .switch {
      width: 100%;
    }
    .btn {
      position: relative;
      border: 0;
      border-radius: 14px;
      padding: 12px 18px;
      font-weight: 600;
      letter-spacing: .3px;
      color: var(--text);
      background: linear-gradient(180deg, rgba(255,255,255,0.18), rgba(255,255,255,0.08));
      border: 1px solid var(--border);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.22), inset 0 1px 0 rgba(255,255,255,0.12);
      cursor: pointer;
      transition: transform 200ms var(--easing), box-shadow 200ms var(--easing), background 200ms var(--easing);
      user-select: none;
    }
    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 26px rgba(0,0,0,0.28), inset 0 1px 0 rgba(255,255,255,0.14);
    }
    .btn:active {
      transform: translateY(0px) scale(0.98);
    }
    .btn.on {
      background: linear-gradient(180deg, rgba(255, 225, 120, 0.35), rgba(255, 225, 120, 0.15));
      box-shadow: 0 10px 24px rgba(255, 215, 130, 0.25), inset 0 1px 0 rgba(255,255,255,0.20);
    }
    .btn.off {
      background: linear-gradient(180deg, rgba(255,255,255,0.12), rgba(255,255,255,0.06));
      opacity: .95;
    }

    /* Toggle switch */
    .switch {
      --switch-w: 76px;
      --switch-h: 40px;
      --thumb: 28px;
      position: relative;
      display: inline-flex;
      align-items: center;
      gap: 10px;
      font-weight: 600;
      color: var(--text);
      padding: 8px 10px;
      border-radius: 16px;
      background: linear-gradient(180deg, rgba(255,255,255,0.10), rgba(255,255,255,0.04));
      border: 1px solid var(--border);
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.12);
      cursor: pointer;
      user-select: none;
    }
    .switch input {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      opacity: 0;
      pointer-events: none;
    }
    .slider {
      position: relative;
      width: var(--switch-w);
      height: var(--switch-h);
      background: linear-gradient(180deg, rgba(255,255,255,0.26), rgba(255,255,255,0.12));
      border: 1px solid var(--border);
      border-radius: 999px;
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.18), inset 0 -6px 12px rgba(0,0,0,0.16);
      transition: background var(--speed) var(--easing), border-color var(--speed) var(--easing);
    }
    .slider::before {
      content: "";
      position: absolute;
      top: 50%;
      left: 6px;
      width: var(--thumb);
      height: var(--thumb);
      transform: translateY(-50%);
      border-radius: 999px;
      background: radial-gradient(60% 60% at 30% 30%, #fff, rgba(255,255,255,0.75));
      box-shadow:
        0 8px 18px rgba(0,0,0,0.24),
        inset 0 1px 0 rgba(255,255,255,0.9);
      transition: left var(--speed) var(--easing), box-shadow var(--speed) var(--easing), background var(--speed) var(--easing);
    }
    .switch[data-checked="true"] .slider {
      background: linear-gradient(180deg, rgba(255, 235, 160, 0.48), rgba(255, 235, 160, 0.22));
      border-color: rgba(255, 220, 130, 0.70);
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.22), 0 0 24px rgba(var(--glow-strong), 0.25);
    }
    .switch[data-checked="true"] .slider::before {
      left: calc(var(--switch-w) - var(--thumb) - 6px);
      background: radial-gradient(60% 60% at 30% 30%, #fff, rgba(255,245,205,0.95));
      box-shadow:
        0 10px 24px rgba(255, 210, 120, 0.45),
        inset 0 1px 0 rgba(255,255,255,0.9);
    }
    .switch-labels {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      color: var(--text-dim);
    }
    .switch .label-on,
    .switch .label-off {
      opacity: .75;
      transition: opacity var(--speed) var(--easing), color var(--speed) var(--easing);
    }
    .switch[data-checked="true"] .label-on {
      color: #ffe27d;
      opacity: 1;
      text-shadow: 0 0 12px rgba(var(--glow-strong), 0.65);
    }
    .switch[data-checked="true"] .label-off {
      opacity: .45;
    }

    .hint {
      margin: 8px 0 0;
      color: var(--text-dim);
      font-size: clamp(11px, 1.9vmin, 13px);
      text-align: center;
      letter-spacing: .2px;
      width: 100%;
    }

    /* SVG Bulb Art */
    svg#bulb {
          width: 100%;
          height: 100%;
          overflow: visible;
          filter: drop-shadow(0 20px 40px rgba(0,0,0,0.35));
          transform: translateY(-5%);
          outline: none;
        }
    /* Hide focus ring for mouse clicks, keep a subtle ring for keyboard users */
    #bulb:focus { outline: none; }
    #bulb:focus-visible {
      outline: 2px solid rgba(255, 226, 125, 0.8);
      outline-offset: 6px;
      border-radius: 18px;
    }
    .glass {
      transition: filter var(--speed) var(--easing), opacity var(--speed) var(--easing), transform var(--speed) var(--easing);
    }
    .is-on .glass {
      filter:
        drop-shadow(0 0 16px rgba(var(--glow-strong), 0.35))
        drop-shadow(0 0 42px rgba(var(--glow-strong), 0.28));
    }
    .filament {
      stroke: rgba(240, 220, 160, 0.85);
      transition: stroke var(--speed) var(--easing), filter var(--speed) var(--easing), opacity var(--speed) var(--easing);
      filter: drop-shadow(0 0 0 rgba(var(--glow-strong), 0));
      opacity: .55;
    }
    .is-on .filament {
      stroke: rgba(255, 220, 130, 1);
      filter: drop-shadow(0 0 12px rgba(var(--glow-strong), 0.85));
      opacity: var(--brightness);
    }
    .base, .screw {
      transition: filter var(--speed) var(--easing), transform var(--speed) var(--easing), opacity var(--speed) var(--easing);
    }
    .is-on .base, .is-on .screw {
      filter: drop-shadow(0 0 14px rgba(var(--glow-strong), 0.25));
    }
    .rays {
      opacity: 0;
      transform-origin: 50% 40%;
      transition: opacity 520ms var(--easing), transform 1200ms ease-in-out;
      transform: scale(0.98) rotate(-2deg);
    }
    .is-on .rays {
      opacity: var(--brightness);
      animation: raysSpin 9s linear infinite;
      transform: scale(1) rotate(0deg);
    }
    @keyframes raysSpin {
      to { transform: rotate(360deg); }
    }

    /* Flicker on activation */
    .flicker .glass,
    .flicker .filament,
    .flicker .rays {
      animation: flick 560ms ease-in-out 1;
    }
    @keyframes flick {
      0%   { opacity: 0.4; filter: none; }
      30%  { opacity: 1;   filter: drop-shadow(0 0 7px rgba(var(--glow-strong), 0.55)); }
      45%  { opacity: 0.8; filter: none; }
      60%  { opacity: 1;   filter: drop-shadow(0 0 10px rgba(var(--glow-strong), 0.85)); }
      75%  { opacity: 0.9; }
      100% { opacity: 1; }
    }

    /* Footer */
    .footer {
      margin-top: 8px;
      display: flex;
      justify-content: center;
      color: var(--text-dim);
      font-size: 12px;
    }

    /* Brightness slider */
    .brightness {
      display: flex;
      align-items: center;
      gap: 12px;
      width: 100%;
      padding: 10px 12px;
      border-radius: 14px;
      background: linear-gradient(180deg, rgba(255,255,255,0.10), rgba(255,255,255,0.04));
      border: 1px solid var(--border);
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.12);
    }
    .brightness label {
      font-size: 13px;
      color: var(--text-dim);
      font-weight: 600;
      letter-spacing: .3px;
      white-space: nowrap;
    }
    .brightness .range {
      -webkit-appearance: none;
      appearance: none;
      width: 100%;
      height: 8px;
      border-radius: 999px;
      background: linear-gradient(180deg, rgba(255,255,255,0.26), rgba(255,255,255,0.12));
      border: 1px solid var(--border);
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.18), inset 0 -6px 12px rgba(0,0,0,0.16);
      outline: none;
    }
    .brightness .range:focus { box-shadow: 0 0 0 3px rgba(255, 226, 125, 0.35), inset 0 1px 0 rgba(255,255,255,0.18); }
    .brightness .range::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 22px; height: 22px;
      border-radius: 50%;
      background: radial-gradient(60% 60% at 30% 30%, #fff, rgba(255,255,255,0.8));
      border: 1px solid rgba(255,255,255,0.6);
      box-shadow: 0 8px 18px rgba(0,0,0,0.24), 0 0 16px rgba(var(--glow-strong), 0.35);
      cursor: pointer;
    }
    .brightness .range::-moz-range-track {
      height: 8px;
      border-radius: 999px;
      background: linear-gradient(180deg, rgba(255,255,255,0.26), rgba(255,255,255,0.12));
      border: 1px solid var(--border);
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.18), inset 0 -6px 12px rgba(0,0,0,0.16);
    }
    .brightness .range::-moz-range-thumb {
      width: 22px; height: 22px;
      border-radius: 50%;
      background: radial-gradient(60% 60% at 30% 30%, #fff, rgba(255,255,255,0.8));
      border: 1px solid rgba(255,255,255,0.6);
      box-shadow: 0 8px 18px rgba(0,0,0,0.24), 0 0 16px rgba(var(--glow-strong), 0.35);
      cursor: pointer;
    }
    .brightness .value {
      min-width: 44px;
      text-align: right;
      font-variant-numeric: tabular-nums;
      color: var(--text-dim);
      font-weight: 600;
    }

    /* Responsive tweaks */
    @media (max-width: 600px) {
      .switch { gap: 8px; }
      .switch-labels { display: none; }
      .scene {
        grid-template-columns: 1fr;
        grid-template-rows: auto 1fr;
      }
      .controls {
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 10px;
      }
      .controls .btn,
      .controls .switch {
        width: auto;
      }
      .hint {
        margin-top: 12px;
      }
    }
  </style>
</head>
<body>
  <div class="grid">
    <section class="card" id="app" aria-live="polite">
      <header class="header">
        <h1 class="title">
          <span class="dot" aria-hidden="true"></span>
          Luminous Bulb
        </h1>
        <p class="subtitle">A delightful, animated on/off experience</p>
      </header>

      <div class="scene">
        <div class="stage float">
          <div class="halo" aria-hidden="true"></div>

          <!-- SVG Bulb -->
          <svg id="bulb" viewBox="0 0 320 360" role="img" aria-labelledby="bulbTitle bulbDesc">
            <title id="bulbTitle">Light Bulb</title>
            <desc id="bulbDesc">A large decorative bulb that can be turned on and off.</desc>
            <defs>
              <!-- Glass gradient OFF -->
              <radialGradient id="glassOff" cx="50%" cy="38%" r="60%">
                <stop offset="0%" stop-color="rgba(255,255,255,1)" stop-opacity="0.45"></stop>
                <stop offset="55%" stop-color="rgba(var(--bulb-glass-off), 0.65)"></stop>
                <stop offset="100%" stop-color="rgba(180, 190, 205, 0.85)"></stop>
              </radialGradient>
              <!-- Glass gradient ON -->
              <radialGradient id="glassOn" cx="50%" cy="38%" r="60%">
                <stop offset="0%" stop-color="rgba(255,255,255,1)" stop-opacity="0.85"></stop>
                <stop offset="45%" stop-color="rgba(var(--bulb-glass-on), 0.95)"></stop>
                <stop offset="100%" stop-color="rgba(255, 222, 120, 0.85)"></stop>
              </radialGradient>

              <!-- Glow radial for rays -->
              <radialGradient id="rayGrad" cx="50%" cy="50%" r="50%">
                <stop offset="10%" stop-color="rgba(255, 236, 170, 0.95)"></stop>
                <stop offset="100%" stop-color="rgba(255, 215, 120, 0)"></stop>
              </radialGradient>

              <!-- Base gradient -->
              <linearGradient id="baseGrad" x1="0%" y1="0%" x2="0%" y2="100%">
                <stop offset="0%" stop-color="rgba(var(--bulb-base), 1)"></stop>
                <stop offset="100%" stop-color="rgba(26, 30, 38, 1)"></stop>
              </linearGradient>

              <!-- Screw gradient -->
              <linearGradient id="screwGrad" x1="0%" y1="0%" x2="0%" y2="100%">
                <stop offset="0%" stop-color="rgba(var(--bulb-screw), 1)"></stop>
                <stop offset="100%" stop-color="rgba(65, 77, 94, 1)"></stop>
              </linearGradient>
            </defs>

            <!-- Rays group (appear when on) -->
            <g class="rays" transform="translate(0, 10)">
              <circle cx="160" cy="170" r="120" fill="url(#rayGrad)"></circle>
              <!-- Decorative rays removed to hide stick lines on light background -->
              <!--
              <g stroke="rgba(255, 225, 120, 0.95)" stroke-width="4" stroke-linecap="round" fill="none" opacity="0.9">
                <path d="M160 18 L160 60" />
                <path d="M280 70 L245 95" />
                <path d="M302 210 L260 205" />
                <path d="M40 210 L80 205" />
                <path d="M20 90 L58 110" />
                <path d="M240 24 L220 62" />
                <path d="M80 24 L98 62" />
              </g>
              -->
            </g>

            <!-- Bulb glass -->
            <g class="glass">
              <!-- Bulb silhouette -->
              <path
                d="M160,24
                   C95,24 44,74 44,138
                   C44,187 72,226 104,252
                   C116,262 122,278 122,294
                   L198,294
                   C198,278 204,262 216,252
                   C248,226 276,187 276,138
                   C276,74 225,24 160,24 Z"
                fill="url(#glassOff)"
                class="glass-off"
              ></path>

              <!-- ON overlay with animated opacity -->
              <path
                d="M160,24
                   C95,24 44,74 44,138
                   C44,187 72,226 104,252
                   C116,262 122,278 122,294
                   L198,294
                   C198,278 204,262 216,252
                   C248,226 276,187 276,138
                   C276,74 225,24 160,24 Z"
                fill="url(#glassOn)"
                class="glass-on"
                style="opacity: 0; transition: opacity var(--speed) var(--easing);"
              ></path>

              <!-- Reflection highlight -->
              <ellipse cx="120" cy="90" rx="30" ry="18" fill="rgba(var(--bulb-reflection), 0.45)"></ellipse>
              <ellipse cx="115" cy="120" rx="16" ry="9" fill="rgba(var(--bulb-reflection), 0.35)"></ellipse>
            </g>

            <!-- Filament and support -->
            <g transform="translate(0, 0)">
              <g stroke-width="6" class="filament" stroke-linecap="round" fill="none">
                <!-- Supports -->
                <path d="M132 218 L132 265" stroke="rgba(170, 170, 170, 0.75)" stroke-width="4"></path>
                <path d="M188 218 L188 265" stroke="rgba(170, 170, 170, 0.75)" stroke-width="4"></path>
                <!-- Filament zigzag -->
                <path d="M132 220
                         Q141 206 150 220
                         Q160 236 170 220
                         Q179 206 188 220" />
              </g>
            </g>

            <!-- Bulb base -->
            <g transform="translate(0, 0)">
              <!-- Neck -->
              <rect x="122" y="294" width="76" height="26" rx="10" fill="url(#baseGrad)" class="base"></rect>
              <!-- Screw rings -->
              <g class="screw">
                <rect x="108" y="320" width="104" height="20" rx="8" fill="url(#screwGrad)"></rect>
                <g fill="rgba(255,255,255,0.12)">
                  <rect x="116" y="324" width="88" height="2" rx="1"></rect>
                  <rect x="116" y="329" width="88" height="2" rx="1"></rect>
                  <rect x="116" y="334" width="88" height="2" rx="1"></rect>
                </g>
                <rect x="130" y="340" width="60" height="16" rx="6" fill="url(#baseGrad)"></rect>
              </g>
            </g>
          </svg>
        </div>

        <!-- Controls -->
        <div class="controls" role="group" aria-label="Bulb controls">
          <button class="btn off" id="btn-off" type="button" aria-label="Turn bulb off">Turn Off</button>

          <label class="switch" id="switch" role="switch" aria-checked="false" tabindex="0" aria-label="Toggle bulb">
            <input type="checkbox" id="toggle" />
            <div class="slider" aria-hidden="true"></div>
            <div class="switch-labels">
              <span class="label-off">Off</span>
              <span class="label-on">On</span>
            </div>
          </label>

          <button class="btn on" id="btn-on" type="button" aria-label="Turn bulb on">Turn On</button>
          
          <div class="brightness" role="group" aria-label="Brightness control">
            <label for="brightness">Brightness</label>
            <input class="range" type="range" id="brightness" min="0" max="100" value="100" aria-valuemin="0" aria-valuemax="100" aria-valuenow="100" aria-label="Bulb brightness" />
            <span class="value" id="brightnessValue">100%</span>
          </div>
          
          <p class="hint">Tip: press Space to toggle â€¢ O = On â€¢ F = Off</p>
        </div>
      </div>

      <footer class="footer">
        <span>Crafted with care Â· Smooth animations Â· Accessible controls</span>
      </footer>
    </section>
  </div>

  <script>
    (() => {
      const app = document.getElementById('app');
      const switchEl = document.getElementById('switch');
      const checkbox = document.getElementById('toggle');
      const btnOn = document.getElementById('btn-on');
      const btnOff = document.getElementById('btn-off');
      const svg = document.getElementById('bulb');
      const glassOn = svg.querySelector('.glass-on');
      const brightnessInput = document.getElementById('brightness');
      const brightnessValue = document.getElementById('brightnessValue');

      const STATE_KEY = 'luminous-bulb:isOn';
      const BRIGHTNESS_KEY = 'luminous-bulb:brightness';

      const getState = () => {
        try {
          const v = localStorage.getItem(STATE_KEY);
          return v === null ? false : JSON.parse(v);
        } catch { return false; }
      };

      const setState = (isOn, opts = { flicker: false }) => {
        app.classList.toggle('is-on', isOn);
        app.classList.toggle('is-off', !isOn);
        switchEl.dataset.checked = String(isOn);
        switchEl.setAttribute('aria-checked', String(isOn));
        checkbox.checked = isOn;
        glassOn.style.opacity = isOn ? 'var(--brightness)' : '0';
        if (svg) {
          svg.setAttribute('role', 'button');
          svg.setAttribute('tabindex', '0');
          svg.setAttribute('aria-pressed', String(isOn));
        }
        try { localStorage.setItem(STATE_KEY, JSON.stringify(isOn)); } catch {}

        // Optional flicker effect when turning on
        if (opts.flicker) {
          app.classList.remove('flicker');
          // force reflow to restart animation
          void app.offsetWidth;
          app.classList.add('flicker');
          setTimeout(() => app.classList.remove('flicker'), 620);
        }
      };

      const toggleState = (opts) => setState(!checkbox.checked, opts);

      const setBrightness = (b) => {
        const clamped = Math.max(0, Math.min(1, Number(b) || 0));
        app.style.setProperty('--brightness', String(clamped));
        const pct = Math.round(clamped * 100);
        if (brightnessValue) brightnessValue.textContent = pct + '%';
        if (brightnessInput) {
          brightnessInput.value = String(pct);
          brightnessInput.setAttribute('aria-valuenow', String(pct));
        }
        try { localStorage.setItem(BRIGHTNESS_KEY, JSON.stringify(clamped)); } catch {}
      };

      // Initialize
      const savedBrightness = (() => {
        try { const v = localStorage.getItem(BRIGHTNESS_KEY); return v === null ? 1 : JSON.parse(v); } catch { return 1; }
      })();
      setBrightness(savedBrightness);
      setState(getState());

      // Events
      checkbox.addEventListener('change', () => setState(checkbox.checked, { flicker: checkbox.checked }));
      switchEl.addEventListener('click', (e) => {
        if (e.target === checkbox) return; // handled by 'change'
        e.preventDefault(); // avoid label default toggling the checkbox again
        toggleState({ flicker: !checkbox.checked });
      });

      // Brightness events
      if (brightnessInput) {
        const onInput = () => setBrightness(Number(brightnessInput.value) / 100);
        brightnessInput.addEventListener('input', onInput);
        brightnessInput.addEventListener('change', onInput);
      }

      // Keyboard: Space toggles, O and F set explicit
      const keyHandler = (e) => {
        if (['INPUT', 'TEXTAREA'].includes(document.activeElement.tagName)) return;
        const key = e.key.toLowerCase();
        if (key === ' ' || key === 'spacebar') {
          e.preventDefault();
          toggleState({ flicker: !checkbox.checked });
        } else if (key === 'o') {
          setState(true, { flicker: true });
        } else if (key === 'f') {
          setState(false);
        }
      };
      document.addEventListener('keydown', keyHandler);

      // Buttons
      btnOn.addEventListener('click', () => setState(true, { flicker: true }));
      btnOff.addEventListener('click', () => setState(false));
      
      // Bulb interactions (local only)
      if (svg) {
        svg.style.cursor = 'pointer';
        svg.addEventListener('click', () => toggleState({ flicker: !checkbox.checked }));
        svg.addEventListener('keydown', (e) => {
          const k = (e.key || '').toLowerCase();
          if (k === ' ' || k === 'enter') {
            e.preventDefault();
            toggleState({ flicker: !checkbox.checked });
          }
        });
      }

      // Reduce motion preference
      const mq = window.matchMedia('(prefers-reduced-motion: reduce)');
      const onReduceMotionChange = () => {
        document.documentElement.style.setProperty('--speed', mq.matches ? '0ms' : '360ms');
      };
      try {
        mq.addEventListener('change', onReduceMotionChange);
      } catch {
        mq.addListener(onReduceMotionChange);
      }
      onReduceMotionChange();

      // Accessibility: keep role="switch" focusable and operable with keyboard
      switchEl.addEventListener('keydown', (e) => {
        const k = e.key.toLowerCase();
        if (k === 'enter' || k === ' ') {
          e.preventDefault();
          toggleState({ flicker: !checkbox.checked });
        }
        if (k === 'arrowright') setState(true, { flicker: true });
        if (k === 'arrowleft') setState(false);
      });

      // Subtle entrance
      requestAnimationFrame(() => {
        app.style.transition = 'filter 600ms var(--easing), transform 600ms var(--easing)';
        app.style.transform = 'translateY(0)';
        app.style.filter = 'none';
      });
    })();
  </script>

</body>
</html>
